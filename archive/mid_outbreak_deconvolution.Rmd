---
title: "Test Mid-outbreak Deconvolution"
author: "Tim Wildauer"
date: "2/6/2020"
output: pdf_document
---

Here we use the same testing as before, but we cut off the infection curve after 120 days (day 150 is the middle of the outbreak) to simulate only having the beginning portion of the outbreak to deconvolve. 

```{r setup, warning=FALSE, message=FALSE}

source('R/package_half.R')
shape=6.2
mean=5.6
scale=mean/shape
sd=sqrt(shape*scale^2)

```

```{r cache=TRUE}
easy_cov = simulate_trials(n=200, mean=mean, sd=sd, distribution="gamma", rl0="random", difficulty = c("easy"))
```
```{r cache=TRUE}
medium_cov = simulate_trials(n=200, mean=mean, sd=sd, distribution="gamma", rl0="random", difficulty = c("medium"))
```
```{r cache=TRUE}
hard_cov = simulate_trials(n=200, mean=mean, sd=sd, distribution="gamma", rl0="random", difficulty = c("hard"))
```

The metrics produced on these deconvolutions use the entire outbreak, but here we derive new metrics ignoring the last few days of the outbreak. By adjusting this amount, we can determine how many days to ignore at the end of the deconvolution during the middle of the outbreak.

```{r echo=FALSE}

new_assessment = function(object, back){
  indices = 1:(120 - back)
    
  object$deconvolution_simple_rmse_new = determine_rmse( object$infection_curves[indices,]
                                                        ,object$deconvolution_simple[indices,])
  
  object$deconvolution_simple_correlation_new = determine_correlation( object$infection_curves[indices,]
                                                                      ,object$deconvolution_simple[indices,])
  
  object$deconvolution_simple_coverage_new = determine_coverage( object$infection_curves[indices,]
                                                                ,object$deconvolution_simple[indices,])
  
  object$deconvolution_random_rmse_new = determine_rmse( object$infection_curves[indices,]
                                                         ,object$deconvolution_random[indices,])
  
  object$deconvolution_random_correlation_new = determine_correlation( object$infection_curves[indices,]
                                                                       ,object$deconvolution_random[indices,])
  
  object$deconvolution_random_coverage_new = determine_coverage( object$infection_curves[indices,]
                                                                 ,object$deconvolution_random[indices,])
  
  object$deconvolution_ridge_rmse_new = determine_rmse( object$infection_curves[indices,]
                                                       ,object$deconvolution_ridge[indices,])
  
  object$deconvolution_ridge_correlation_new = determine_correlation( object$infection_curves[indices,]
                                                                     ,object$deconvolution_ridge[indices,])
  
  object$deconvolution_ridge_coverage_new = determine_coverage( object$infection_curves[indices,]
                                                               ,object$deconvolution_ridge[indices,])
  
  object$deconvolution_rl_rmse_new = determine_rmse( object$infection_curves[indices,]
                                                    ,object$deconvolution_rl[indices,])
  
  object$deconvolution_rl_correlation_new = determine_correlation( object$infection_curves[indices,]
                                                                  ,object$deconvolution_rl[indices,])
  
  object$deconvolution_rl_coverage_new = determine_coverage( object$infection_curves[indices,]
                                                            ,object$deconvolution_rl[indices,])
  
  object$deconvolution_fourier_rmse_new = determine_rmse( object$infection_curves[indices,]
                                                         ,object$deconvolution_fourier[indices,])
  
  object$deconvolution_fourier_correlation_new = determine_correlation( object$infection_curves[indices,]
                                                                       ,object$deconvolution_fourier[indices,])
  
  object$deconvolution_fourier_coverage_new = determine_coverage( object$infection_curves[indices,]
                                                                 ,object$deconvolution_fourier[indices,])
  
  object$deconvolution_frequency_rmse_new = determine_rmse( object$infection_curves[indices,]
                                                           ,object$deconvolution_frequency[indices,])
  
  object$deconvolution_frequency_correlation_new = determine_correlation( object$infection_curves[indices,]
                                                                         ,object$deconvolution_frequency[indices,])
  
  object$deconvolution_frequency_coverage_new = determine_coverage( object$infection_curves[indices,]
                                                                   ,object$deconvolution_frequency[indices,])
  
  object$deconvolution_average_rmse_new = determine_rmse( object$infection_curves[indices,]
                                                         ,object$deconvolution_average[indices,])
  
  object$deconvolution_average_correlation_new = determine_correlation( object$infection_curves[indices,]
                                                                       ,object$deconvolution_average[indices,])
  
  object$deconvolution_average_coverage_new = determine_coverage( object$infection_curves[indices,]
                                                                ,object$deconvolution_average[indices,])
  
  return(object)
}

```

Here we back up 7 days ard recalculate the correlation, RMSE, and coverage. Coverage is known to not be a good indicator of good fit, so it is not graphed below.

```{r }

back=7
easy_cov$easy = new_assessment(easy_cov$easy, back)
medium_cov$medium = new_assessment(medium_cov$medium, back)
hard_cov$hard = new_assessment(hard_cov$hard, back)

```

Here we give plots for each of the methods for each of the three difficulties, comparing correlation and RMSE during the entire outbreak vs. correlation and RMSE using everything but the last 7 days of the outbreak.

```{r echo=FALSE}
print(' ')
boxplot( easy_cov$easy$deconvolution_simple_correlation
        ,medium_cov$medium$deconvolution_simple_correlation
        ,hard_cov$hard$deconvolution_simple_correlation
        ,easy_cov$easy$deconvolution_simple_correlation_new
        ,medium_cov$medium$deconvolution_simple_correlation_new
        ,hard_cov$hard$deconvolution_simple_correlation_new
        ,names=c("easy", "medium", "hard", "easy new", "medium new", "hard new")
        ,main="simple correlation"
        ,ylim=c(0.9,1))
print(' ')
boxplot( easy_cov$easy$deconvolution_simple_rmse
        ,medium_cov$medium$deconvolution_simple_rmse
        ,hard_cov$hard$deconvolution_simple_rmse
        ,easy_cov$easy$deconvolution_simple_rmse_new
        ,medium_cov$medium$deconvolution_simple_rmse_new
        ,hard_cov$hard$deconvolution_simple_rmse_new
        ,names=c("easy", "medium", "hard", "easy new", "medium new", "hard new")
        ,main="simple RMSE"
        ,ylim=c(0.5,5))
print(' ')
boxplot( easy_cov$easy$deconvolution_random_correlation
        ,medium_cov$medium$deconvolution_random_correlation
        ,hard_cov$hard$deconvolution_random_correlation
        ,easy_cov$easy$deconvolution_random_correlation_new
        ,medium_cov$medium$deconvolution_random_correlation_new
        ,hard_cov$hard$deconvolution_random_correlation_new
        ,names=c("easy", "medium", "hard", "easy new", "medium new", "hard new")
        ,main="random correlation"
        ,ylim=c(0.9,1))
print(' ')
boxplot( easy_cov$easy$deconvolution_random_rmse
        ,medium_cov$medium$deconvolution_random_rmse
        ,hard_cov$hard$deconvolution_random_rmse
        ,easy_cov$easy$deconvolution_random_rmse_new
        ,medium_cov$medium$deconvolution_random_rmse_new
        ,hard_cov$hard$deconvolution_random_rmse_new
        ,names=c("easy", "medium", "hard", "easy new", "medium new", "hard new")
        ,main="random RMSE"
        ,ylim=c(0.5,5))
print(' ')
boxplot( easy_cov$easy$deconvolution_ridge_correlation
        ,medium_cov$medium$deconvolution_ridge_correlation
        ,hard_cov$hard$deconvolution_ridge_correlation
        ,easy_cov$easy$deconvolution_ridge_correlation_new
        ,medium_cov$medium$deconvolution_ridge_correlation_new
        ,hard_cov$hard$deconvolution_ridge_correlation_new
        ,names=c("easy", "medium", "hard", "easy new", "medium new", "hard new")
        ,main="ridge correlation"
        ,ylim=c(0.9,1))
print(' ')
boxplot( easy_cov$easy$deconvolution_ridge_rmse
        ,medium_cov$medium$deconvolution_ridge_rmse
        ,hard_cov$hard$deconvolution_ridge_rmse
        ,easy_cov$easy$deconvolution_ridge_rmse_new
        ,medium_cov$medium$deconvolution_ridge_rmse_new
        ,hard_cov$hard$deconvolution_ridge_rmse_new
        ,names=c("easy", "medium", "hard", "easy new", "medium new", "hard new")
        ,main="ridge RMSE"
        ,ylim=c(0.5,5))
print(' ')
boxplot( easy_cov$easy$deconvolution_rl_correlation
        ,medium_cov$medium$deconvolution_rl_correlation
        ,hard_cov$hard$deconvolution_rl_correlation
        ,easy_cov$easy$deconvolution_rl_correlation_new
        ,medium_cov$medium$deconvolution_rl_correlation_new
        ,hard_cov$hard$deconvolution_rl_correlation_new
        ,names=c("easy", "medium", "hard", "easy new", "medium new", "hard new")
        ,main="rl correlation"
        ,ylim=c(0.9,1))
print(' ')
boxplot( easy_cov$easy$deconvolution_rl_rmse
        ,medium_cov$medium$deconvolution_rl_rmse
        ,hard_cov$hard$deconvolution_rl_rmse
        ,easy_cov$easy$deconvolution_rl_rmse_new
        ,medium_cov$medium$deconvolution_rl_rmse_new
        ,hard_cov$hard$deconvolution_rl_rmse_new
        ,names=c("easy", "medium", "hard", "easy new", "medium new", "hard new")
        ,main="rl RMSE"
        ,ylim=c(0.5,5))
print(' ')
boxplot( easy_cov$easy$deconvolution_fourier_correlation
        ,medium_cov$medium$deconvolution_fourier_correlation
        ,hard_cov$hard$deconvolution_fourier_correlation
        ,easy_cov$easy$deconvolution_fourier_correlation_new
        ,medium_cov$medium$deconvolution_fourier_correlation_new
        ,hard_cov$hard$deconvolution_fourier_correlation_new
        ,names=c("easy", "medium", "hard", "easy new", "medium new", "hard new")
        ,main="fourier correlation"
        ,ylim=c(0.9,1))
print(' ')
boxplot( easy_cov$easy$deconvolution_fourier_rmse
        ,medium_cov$medium$deconvolution_fourier_rmse
        ,hard_cov$hard$deconvolution_fourier_rmse
        ,easy_cov$easy$deconvolution_fourier_rmse_new
        ,medium_cov$medium$deconvolution_fourier_rmse_new
        ,hard_cov$hard$deconvolution_fourier_rmse_new
        ,names=c("easy", "medium", "hard", "easy new", "medium new", "hard new")
        ,main="fourier RMSE"
        ,ylim=c(0.5,5))
print(' ')
boxplot( easy_cov$easy$deconvolution_frequency_correlation
        ,medium_cov$medium$deconvolution_frequency_correlation
        ,hard_cov$hard$deconvolution_frequency_correlation
        ,easy_cov$easy$deconvolution_frequency_correlation_new
        ,medium_cov$medium$deconvolution_frequency_correlation_new
        ,hard_cov$hard$deconvolution_frequency_correlation_new
        ,names=c("easy", "medium", "hard", "easy new", "medium new", "hard new")
        ,main="frequency correlation"
        ,ylim=c(0.9,1))
print(' ')
boxplot( easy_cov$easy$deconvolution_frequency_rmse
        ,medium_cov$medium$deconvolution_frequency_rmse
        ,hard_cov$hard$deconvolution_frequency_rmse
        ,easy_cov$easy$deconvolution_frequency_rmse_new
        ,medium_cov$medium$deconvolution_frequency_rmse_new
        ,hard_cov$hard$deconvolution_frequency_rmse_new
        ,names=c("easy", "medium", "hard", "easy new", "medium new", "hard new")
        ,main="frequency RMSE"
        ,ylim=c(0.5,5))
print(' ')
boxplot( easy_cov$easy$deconvolution_average_correlation
        ,medium_cov$medium$deconvolution_average_correlation
        ,hard_cov$hard$deconvolution_average_correlation
        ,easy_cov$easy$deconvolution_average_correlation_new
        ,medium_cov$medium$deconvolution_average_correlation_new
        ,hard_cov$hard$deconvolution_average_correlation_new
        ,names=c("easy", "medium", "hard", "easy new", "medium new", "hard new")
        ,main="average correlation"
        ,ylim=c(0.9,1))
print(' ')
boxplot( easy_cov$easy$deconvolution_average_rmse
        ,medium_cov$medium$deconvolution_average_rmse
        ,hard_cov$hard$deconvolution_average_rmse
        ,easy_cov$easy$deconvolution_average_rmse_new
        ,medium_cov$medium$deconvolution_average_rmse_new
        ,hard_cov$hard$deconvolution_average_rmse_new
        ,names=c("easy", "medium", "hard", "easy new", "medium new", "hard new")
        ,main="average RMSE"
        ,ylim=c(0.5,5))
print(' ')


```

It is clear that the random method produces the closest fit after backing up 7 days from the last day of the current outbreak. 

To adapt this to the nCoV outbreak, I would like to back up the curve 3 more days. These curves are parabolic and have a downward curvature. The curvature of the current outbreak is not known at this point. Over the past week it has increased around 20% or more every day. It is possible that that is starting to go down, but with an upward curvature, the random method would be losing more cases to project backwards. The RMSE and correlation when backed up 10 days is still remarkably good for easy and medium curves.
