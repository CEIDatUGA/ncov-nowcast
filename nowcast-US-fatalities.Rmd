---
title: "Nowcasting from fatalities"
date: "`r format(Sys.time(), '%B %d, %Y')`"
output:
  html_document:
    df_print: paged
---

<!-- Knit this page second -->

```{r setup, include=FALSE}

library(tidyverse)
library(tibbletime)
library(padr)
library(tvReg)
library(forecast)
source('R/nowcast.R')
# source('R/data.R')
```

<!-- Get fatalities reports for US states -->
```{r data, include=FALSE, message = FALSE, warning = FALSE, cache = FALSE}
fatalities.US <- readRDS('data/fatalities.US.rds')
```

<!-- Set params for US -->
```{r params, include=FALSE, message = FALSE, warning = FALSE, cache = FALSE}
params.US <- readRDS('data/params.US.rds')
```

Only states with more than 10 fatalities reported on any given day are shown.

## {.tabset .tabset-fade}

### USA
<!-- calculate nowcasts for entire US  -->
```{r nowcast_US, include=FALSE, echo=FALSE, message = FALSE, warning = FALSE, cache = FALSE}

get_US_nowcast <- function(state) {
  fatalities.US %>% select(Date, deaths = state) %>% 
    tbl_time(index = Date) %>% nowcast_from_deaths_with_onset_to_death(params.US)
}

US.all <- get_US_nowcast("US")
# saveRDS(US.all,"data/US.nowcast.from.fatalities.rds")

```


```{r US, echo=FALSE, message = FALSE, warning = FALSE, cache = FALSE, out.width = '100%'}
plot_nowcast_from_death_reports(US.all) # %>% plotly::layout(showlegend=TRUE)

# fatalities.maxdaily <- sapply(fatalities.US[,-1], max, na.rm = TRUE)
# which(fatalities.maxdaily >= 10)
```
<!-- calculate nowcasts for US states -->
```{r nowcast_states, include=FALSE, echo=FALSE, message = FALSE, warning = FALSE, cache = FALSE}

# AK <- get_US_nowcast("AK")
# AL <- get_US_nowcast("AL")
# AR <- get_US_nowcast("AR")
# AZ <- get_US_nowcast("AZ")
CA <- get_US_nowcast("CA")
CO <- get_US_nowcast("CO")
# CT <- get_US_nowcast("CT")
# DC <- get_US_nowcast("DC")
# DE <- get_US_nowcast("DE")
FL <- get_US_nowcast("FL")
GA <- get_US_nowcast("GA")
# HI <- get_US_nowcast("HI")
# IA <- get_US_nowcast("IA")
# ID <- get_US_nowcast("ID")
IL <- get_US_nowcast("IL")
# IN <- get_US_nowcast("IN")
# KS <- get_US_nowcast("KS")
# KY <- get_US_nowcast("KY")
LA <- get_US_nowcast("LA")
MA <- get_US_nowcast("MA")
# MD <- get_US_nowcast("MD")
# ME <- get_US_nowcast("ME")
MI <- get_US_nowcast("MI")
# MN <- get_US_nowcast("MN")
# MO <- get_US_nowcast("MO")
# MS <- get_US_nowcast("MS")
# MT <- get_US_nowcast("MT")
# NC <- get_US_nowcast("NC")
# ND <- get_US_nowcast("ND")
# NE <- get_US_nowcast("NE")
# NH <- get_US_nowcast("NH")
NJ <- get_US_nowcast("NJ")
# NM <- get_US_nowcast("NM")
# NV <- get_US_nowcast("NV")
NY <- get_US_nowcast("NY")
# OH <- get_US_nowcast("OH")
# OK <- get_US_nowcast("OK")
# OR <- get_US_nowcast("OR")
PA <- get_US_nowcast("PA")
# RI <- get_US_nowcast("RI")
# SC <- get_US_nowcast("SC")
# SD <- get_US_nowcast("SD")
# TN <- get_US_nowcast("TN")
# TX <- get_US_nowcast("TX")
# UT <- get_US_nowcast("UT")
# VA <- get_US_nowcast("VA")
# VT <- get_US_nowcast("VT")
WA <- get_US_nowcast("WA")
# WI <- get_US_nowcast("WI")
# WY <- get_US_nowcast("WY")
```

<!-- ### AK -->
<!-- ```{r AK, echo=FALSE, message = FALSE, warning = FALSE, cache = FALSE, out.width = '100%'} -->
<!-- plot_nowcast_from_death_reports(AK) -->
<!-- ``` -->

<!-- ### AL -->
<!-- ```{r AL, echo=FALSE, message = FALSE, warning = FALSE, cache = FALSE, out.width = '100%'} -->
<!-- plot_nowcast_from_death_reports(AL) -->
<!-- ``` -->

<!-- ### AR -->
<!-- ```{r AR, echo=FALSE, message = FALSE, warning = FALSE, cache = FALSE, out.width = '100%'} -->
<!-- plot_nowcast_from_death_reports(AR) -->
<!-- ``` -->

<!-- ### AZ -->
<!-- ```{r AZ, echo=FALSE, message = FALSE, warning = FALSE, cache = FALSE, out.width = '100%'} -->
<!-- plot_nowcast_from_death_reports(AZ) -->
<!-- ``` -->

### CA
```{r CA, echo=FALSE, message = FALSE, warning = FALSE, cache = FALSE, out.width = '100%'}
plot_nowcast_from_death_reports(CA)
```

### CO
```{r CO, echo=FALSE, message = FALSE, warning = FALSE, cache = FALSE, out.width = '100%'}
plot_nowcast_from_death_reports(CO)
```

<!-- ### CT -->
<!-- ```{r CT, echo=FALSE, message = FALSE, warning = FALSE, cache = FALSE, out.width = '100%'} -->
<!-- plot_nowcast_from_death_reports(CT) -->
<!-- ``` -->

<!-- ### DC -->
<!-- ```{r DC, echo=FALSE, message = FALSE, warning = FALSE, cache = FALSE, out.width = '100%'} -->
<!-- plot_nowcast_from_death_reports(DC) -->
<!-- ``` -->

<!-- ### DE -->
<!-- ```{r DE, echo=FALSE, message = FALSE, warning = FALSE, cache = FALSE, out.width = '100%'} -->
<!-- plot_nowcast_from_death_reports(DE) -->
<!-- ``` -->

### FL
```{r FL, echo=FALSE, message = FALSE, warning = FALSE, cache = FALSE, out.width = '100%'}
plot_nowcast_from_death_reports(FL)
```

### GA
```{r GA, echo=FALSE, message = FALSE, warning = FALSE, cache = FALSE, out.width = '100%'}
plot_nowcast_from_death_reports(GA)
```

<!-- ### HI -->
<!-- ```{r HI, echo=FALSE, message = FALSE, warning = FALSE, cache = FALSE, out.width = '100%'} -->
<!-- plot_nowcast_from_death_reports(HI) -->
<!-- ``` -->

<!-- ### IA -->
<!-- ```{r IA, echo=FALSE, message = FALSE, warning = FALSE, cache = FALSE, out.width = '100%'} -->
<!-- plot_nowcast_from_death_reports(IA) -->
<!-- ``` -->

<!-- ### ID -->
<!-- ```{r ID, echo=FALSE, message = FALSE, warning = FALSE, cache = FALSE, out.width = '100%'} -->
<!-- plot_nowcast_from_death_reports(ID) -->
<!-- ``` -->

### IL
```{r IL, echo=FALSE, message = FALSE, warning = FALSE, cache = FALSE, out.width = '100%'}
plot_nowcast_from_death_reports(IL)
```

<!-- ### IN -->
<!-- ```{r IN, echo=FALSE, message = FALSE, warning = FALSE, cache = FALSE, out.width = '100%'} -->
<!-- plot_nowcast_from_death_reports(IN) -->
<!-- ``` -->

<!-- ### KS -->
<!-- ```{r KS, echo=FALSE, message = FALSE, warning = FALSE, cache = FALSE, out.width = '100%'} -->
<!-- plot_nowcast_from_death_reports(KS) -->
<!-- ``` -->

<!-- ### KY -->
<!-- ```{r KY, echo=FALSE, message = FALSE, warning = FALSE, cache = FALSE, out.width = '100%'} -->
<!-- plot_nowcast_from_death_reports(KY) -->
<!-- ``` -->

### LA
```{r LA, echo=FALSE, message = FALSE, warning = FALSE, cache = FALSE, out.width = '100%'}
plot_nowcast_from_death_reports(LA)
```

### MA
```{r MA, echo=FALSE, message = FALSE, warning = FALSE, cache = FALSE, out.width = '100%'}
plot_nowcast_from_death_reports(MA)
```

<!-- ### MD -->
<!-- ```{r MD, echo=FALSE, message = FALSE, warning = FALSE, cache = FALSE, out.width = '100%'} -->
<!-- plot_nowcast_from_death_reports(MD) -->
<!-- ``` -->

<!-- ### ME -->
<!-- ```{r ME, echo=FALSE, message = FALSE, warning = FALSE, cache = FALSE, out.width = '100%'} -->
<!-- plot_nowcast_from_death_reports(ME) -->
<!-- ``` -->

### MI
```{r MI, echo=FALSE, message = FALSE, warning = FALSE, cache = FALSE, out.width = '100%'}
plot_nowcast_from_death_reports(MI)
```

<!-- ### MN -->
<!-- ```{r MN, echo=FALSE, message = FALSE, warning = FALSE, cache = FALSE, out.width = '100%'} -->
<!-- plot_nowcast_from_death_reports(MN) -->
<!-- ``` -->

<!-- ### MO -->
<!-- ```{r MO, echo=FALSE, message = FALSE, warning = FALSE, cache = FALSE, out.width = '100%'} -->
<!-- plot_nowcast_from_death_reports(MO) -->
<!-- ``` -->

<!-- ### MS -->
<!-- ```{r MS, echo=FALSE, message = FALSE, warning = FALSE, cache = FALSE, out.width = '100%'} -->
<!-- plot_nowcast_from_death_reports(MS) -->
<!-- ``` -->

<!-- ### MT -->
<!-- ```{r MT, echo=FALSE, message = FALSE, warning = FALSE, cache = FALSE, out.width = '100%'} -->
<!-- plot_nowcast_from_death_reports(MT) -->
<!-- ``` -->

<!-- ### NC -->
<!-- ```{r NC, echo=FALSE, message = FALSE, warning = FALSE, cache = FALSE, out.width = '100%'} -->
<!-- plot_nowcast_from_death_reports(NC) -->
<!-- ``` -->

<!-- ### ND -->
<!-- ```{r ND, echo=FALSE, message = FALSE, warning = FALSE, cache = FALSE, out.width = '100%'} -->
<!-- plot_nowcast_from_death_reports(ND) -->
<!-- ``` -->

<!-- ### NE -->
<!-- ```{r NE, echo=FALSE, message = FALSE, warning = FALSE, cache = FALSE, out.width = '100%'} -->
<!-- plot_nowcast_from_death_reports(NE) -->
<!-- ``` -->

<!-- ### NH -->
<!-- ```{r NH, echo=FALSE, message = FALSE, warning = FALSE, cache = FALSE, out.width = '100%'} -->
<!-- plot_nowcast_from_death_reports(NH) -->
<!-- ``` -->

### NJ
```{r NJ, echo=FALSE, message = FALSE, warning = FALSE, cache = FALSE, out.width = '100%'}
plot_nowcast_from_death_reports(NJ)
```

<!-- ### NM -->
<!-- ```{r NM, echo=FALSE, message = FALSE, warning = FALSE, cache = FALSE, out.width = '100%'} -->
<!-- plot_nowcast_from_death_reports(NM) -->
<!-- ``` -->

<!-- ### NV -->
<!-- ```{r NV, echo=FALSE, message = FALSE, warning = FALSE, cache = FALSE, out.width = '100%'} -->
<!-- plot_nowcast_from_death_reports(NV) -->
<!-- ``` -->

### NY
```{r NY, echo=FALSE, message = FALSE, warning = FALSE, cache = FALSE, out.width = '100%'}
plot_nowcast_from_death_reports(NY)
```

<!-- ### OH -->
<!-- ```{r OH, echo=FALSE, message = FALSE, warning = FALSE, cache = FALSE, out.width = '100%'} -->
<!-- plot_nowcast_from_death_reports(OH) -->
<!-- ``` -->

<!-- ### OK -->
<!-- ```{r OK, echo=FALSE, message = FALSE, warning = FALSE, cache = FALSE, out.width = '100%'} -->
<!-- plot_nowcast_from_death_reports(OK) -->
<!-- ``` -->

<!-- ### OR -->
<!-- ```{r OR, echo=FALSE, message = FALSE, warning = FALSE, cache = FALSE, out.width = '100%'} -->
<!-- plot_nowcast_from_death_reports(OR) -->
<!-- ``` -->

### PA
```{r PA, echo=FALSE, message = FALSE, warning = FALSE, cache = FALSE, out.width = '100%'}
plot_nowcast_from_death_reports(PA)
```

<!-- ### RI -->
<!-- ```{r RI, echo=FALSE, message = FALSE, warning = FALSE, cache = FALSE, out.width = '100%'} -->
<!-- plot_nowcast_from_death_reports(RI) -->
<!-- ``` -->

<!-- ### SC -->
<!-- ```{r SC, echo=FALSE, message = FALSE, warning = FALSE, cache = FALSE, out.width = '100%'} -->
<!-- plot_nowcast_from_death_reports(SC) -->
<!-- ``` -->

<!-- ### SD -->
<!-- ```{r SD, echo=FALSE, message = FALSE, warning = FALSE, cache = FALSE, out.width = '100%'} -->
<!-- plot_nowcast_from_death_reports(SD) -->
<!-- ``` -->

<!-- ### TN -->
<!-- ```{r TN, echo=FALSE, message = FALSE, warning = FALSE, cache = FALSE, out.width = '100%'} -->
<!-- plot_nowcast_from_death_reports(TN) -->
<!-- ``` -->

<!-- ### TX -->
<!-- ```{r TX, echo=FALSE, message = FALSE, warning = FALSE, cache = FALSE, out.width = '100%'} -->
<!-- plot_nowcast_from_death_reports(TX) -->
<!-- ``` -->

<!-- ### UT -->
<!-- ```{r UT, echo=FALSE, message = FALSE, warning = FALSE, cache = FALSE, out.width = '100%'} -->
<!-- plot_nowcast_from_death_reports(UT) -->
<!-- ``` -->

<!-- ### VA -->
<!-- ```{r VA, echo=FALSE, message = FALSE, warning = FALSE, cache = FALSE, out.width = '100%'} -->
<!-- plot_nowcast_from_death_reports(VA) -->
<!-- ``` -->

<!-- ### VT -->
<!-- ```{r VT, echo=FALSE, message = FALSE, warning = FALSE, cache = FALSE, out.width = '100%'} -->
<!-- plot_nowcast_from_death_reports(VT) -->
<!-- ``` -->

### WA
```{r WA, echo=FALSE, message = FALSE, warning = FALSE, cache = FALSE, out.width = '100%'}
plot_nowcast_from_death_reports(WA)
```

<!-- ### WI -->
<!-- ```{r WI, echo=FALSE, message = FALSE, warning = FALSE, cache = FALSE, out.width = '100%'} -->
<!-- plot_nowcast_from_death_reports(WI) -->
<!-- ``` -->

<!-- ### WY -->
<!-- ```{r WY, echo=FALSE, message = FALSE, warning = FALSE, cache = FALSE, out.width = '100%'} -->
<!-- plot_nowcast_from_death_reports(WY) -->
<!-- ``` -->

## ![](nowcast-legend-deaths.png)

The nowcast for the whole US is calculated from case reports at the national level. It is not the sum of the state level nowcasts. The nowcast for the whole US does not necessarily agree with the the sum of state level nowcasts.

### Parameters

**Infection fatality rate** = `r params.US$IFR`

**Symptom-onset-to-reporting interval:**  
Distribution: `r params.US$effective.infectious.period$dist`  
Mean = `r params.US$effective.infectious.period$mean`  
Shape = `r params.US$effective.infectious.period$shape`

**Incubation period:**  
Distribution: `r params.US$incubation.period$dist`  
Mean = `r params.US$incubation.period$mean`  
Shape = `r params.US$incubation.period$shape`

**Symmptom-onset-to-death interval:**  
Distribution: `r params.US$onset.to.death.period$dist`  
Mean = `r params.US$onset.to.death.period$mean`  
Shape = `r params.US$onset.to.death.period$shape`  