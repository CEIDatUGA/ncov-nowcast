---
title: "Nowcasting from case reports"
date: "`r format(Sys.time(), '%B %d, %Y')`"
output:
  html_document:
    df_print: paged
---

```{r setup, include=FALSE}

library(tidyverse)
library(tibbletime)
library(padr)
library(tvReg)
library(forecast)
source('R/package.R')
source('R/deconcolve.R')
source('R/simple_tdar.R')
source('R/package_tv.R')
source('R/nowcast.R')

```

<!-- Set params for US -->
```{r params, echo=FALSE, message = FALSE, warning = FALSE, cache = TRUE}
US.params <- list(admin = "US", # state or country
                  # q = 1, # Detection probability
                  a = 0.346, # Proportion of cases that are asymptomatic
                  # c = 1, # Transmissability of undetectable cases
                  # effective.infectious.period = list(dist="exponential", mean=2.67),
                  effective.infectious.period = list(dist="gamma", mean=4.4, shape=1.9816403),
                  infectious.period = list(dist="exponential", mean=7),
                  incubation.period = list(dist="gamma", mean=7.67, shape=4.1775942)
                  )
```

<!-- Get case reports for US states -->
```{r data, include=FALSE, message = FALSE, warning = FALSE, cache = FALSE}
# read data directly from google sheet.

# sheet <- "https://docs.google.com/spreadsheets/d/10NYNf4UX7R_nNdM-jkbo7A5SGkB8sUVMIiqU7e_-miU/edit#gid=0"
# 
# US <- googlesheets4::sheets_read(sheet)
# 
# US <- US %>% 
#   rename_all(list(~make.names(.))) %>% 
#   mutate_if(is.list, fixcolumns) %>% 
#   mutate(Date = as.Date(Date)) %>% 
#   padr::pad(start_val = as.Date("2019-12-01")) %>%
#   replace(., is.na(.), 0) %>%
#   tibbletime::as_tbl_time(index=Date) %>% 
#   mutate(US = rowSums(.[,-1],na.rm = TRUE))


# Scrape Wikipedia

library(rvest)
url <- "https://en.wikipedia.org/wiki/2020_coronavirus_pandemic_in_the_United_States"

US.wikipedia <- url %>%
  html() %>%
  html_nodes(xpath='//*[@id="mw-content-text"]/div/div[25]/table/tbody/tr[2]/td/table') %>%
  html_table(fill = TRUE)
US.wikipedia <- US.wikipedia[[1]]
names(US.wikipedia) <- US.wikipedia[1,]
US.wikipedia <- US.wikipedia[2:(nrow(US.wikipedia)-5),1:(ncol(US.wikipedia)-6)]

US.wikipedia$Date <- paste(US.wikipedia$Date, "2020") %>% 
  as.Date("%b %d %Y")

US <- US.wikipedia %>%
  mutate_if(sapply(US.wikipedia, is.character), as.numeric) %>% 
  rename_all(list(~make.names(.))) %>% 
  padr::pad(start_val = as.Date("2019-12-01")) %>%
  replace(., is.na(.), 0) %>%
  tibbletime::as_tbl_time(index=Date) %>% 
  mutate(US = rowSums(.[,-1],na.rm = TRUE))

# Remove last row
US.wikipedia <- US.wikipedia[-nrow(US.wikipedia),]

```

<!-- calculate nowcasts for US states -->
```{r nowcasts, include=FALSE, echo=FALSE, message = FALSE, warning = FALSE, cache = FALSE}

get_US_nowcast <- function(state) {
  US %>% select(Date, cases = state) %>% 
    tbl_time(index = Date) %>% nowcast_from_case_reports(US.params)
}

US.all <- get_US_nowcast("US")
saveRDS(US.all,"US.nowcast.from.cases.rds")

AK <- get_US_nowcast("AK")
AL <- get_US_nowcast("AL")
AR <- get_US_nowcast("AR")
AZ <- get_US_nowcast("AZ")
CA <- get_US_nowcast("CA")
CO <- get_US_nowcast("CO")
CT <- get_US_nowcast("CT")
DC <- get_US_nowcast("DC")
DE <- get_US_nowcast("DE")
FL <- get_US_nowcast("FL")
GA <- get_US_nowcast("GA")
HI <- get_US_nowcast("HI")
IA <- get_US_nowcast("IA")
IL <- get_US_nowcast("IL")
IN <- get_US_nowcast("IN")
KS <- get_US_nowcast("KS")
KY <- get_US_nowcast("KY")
LA <- get_US_nowcast("LA")
MA <- get_US_nowcast("MA")
MD <- get_US_nowcast("MD")
ME <- get_US_nowcast("ME")
MI <- get_US_nowcast("MI")
MN <- get_US_nowcast("MN")
MO <- get_US_nowcast("MO")
MS <- get_US_nowcast("MS")
MT <- get_US_nowcast("MT")
NC <- get_US_nowcast("NC")
ND <- get_US_nowcast("ND")
NE <- get_US_nowcast("NE")
NH <- get_US_nowcast("NH")
NJ <- get_US_nowcast("NJ")
NM <- get_US_nowcast("NM")
NV <- get_US_nowcast("NV")
NY <- get_US_nowcast("NY")
OH <- get_US_nowcast("OH")
OK <- get_US_nowcast("OK")
OR <- get_US_nowcast("OR")
PA <- get_US_nowcast("PA")
RI <- get_US_nowcast("RI")
SC <- get_US_nowcast("SC")
SD <- get_US_nowcast("SD")
TN <- get_US_nowcast("TN")
TX <- get_US_nowcast("TX")
UT <- get_US_nowcast("UT")
VA <- get_US_nowcast("VA")
VT <- get_US_nowcast("VT")
WA <- get_US_nowcast("WA")
WI <- get_US_nowcast("WI")
WY <- get_US_nowcast("WY")
```

## {.tabset .tabset-fade}

### USA
```{r US, echo=FALSE, message = FALSE, warning = FALSE, cache = FALSE, out.width = '100%'}
plot_nowcast_from_case_reports(US.all)
```

### AK
```{r AK, echo=FALSE, message = FALSE, warning = FALSE, cache = FALSE, out.width = '100%'}
plot_nowcast_from_case_reports(AK)
```

### AL
```{r AL, echo=FALSE, message = FALSE, warning = FALSE, cache = FALSE, out.width = '100%'}
plot_nowcast_from_case_reports(AL)
```

### AR
```{r AR, echo=FALSE, message = FALSE, warning = FALSE, cache = FALSE, out.width = '100%'}
plot_nowcast_from_case_reports(AR)
```

### AZ
```{r AZ, echo=FALSE, message = FALSE, warning = FALSE, cache = FALSE, out.width = '100%'}
plot_nowcast_from_case_reports(AZ)
```

### CA
```{r CA, echo=FALSE, message = FALSE, warning = FALSE, cache = FALSE, out.width = '100%'}
plot_nowcast_from_case_reports(CA)
```

### CO
```{r CO, echo=FALSE, message = FALSE, warning = FALSE, cache = FALSE, out.width = '100%'}
plot_nowcast_from_case_reports(CO)
```

### CT
```{r CT, echo=FALSE, message = FALSE, warning = FALSE, cache = FALSE, out.width = '100%'}
plot_nowcast_from_case_reports(CT)
```

### DC
```{r DC, echo=FALSE, message = FALSE, warning = FALSE, cache = FALSE, out.width = '100%'}
plot_nowcast_from_case_reports(DC)
```

### DE
```{r DE, echo=FALSE, message = FALSE, warning = FALSE, cache = FALSE, out.width = '100%'}
plot_nowcast_from_case_reports(DE)
```

### FL
```{r FL, echo=FALSE, message = FALSE, warning = FALSE, cache = FALSE, out.width = '100%'}
plot_nowcast_from_case_reports(FL)
```

### GA
```{r GA, echo=FALSE, message = FALSE, warning = FALSE, cache = FALSE, out.width = '100%'}
plot_nowcast_from_case_reports(GA)
```

### HI
```{r HI, echo=FALSE, message = FALSE, warning = FALSE, cache = FALSE, out.width = '100%'}
plot_nowcast_from_case_reports(HI)
```

### IA
```{r IA, echo=FALSE, message = FALSE, warning = FALSE, cache = FALSE, out.width = '100%'}
plot_nowcast_from_case_reports(IA)
```

### IL
```{r IL, echo=FALSE, message = FALSE, warning = FALSE, cache = FALSE, out.width = '100%'}
plot_nowcast_from_case_reports(IL)
```

### IN
```{r IN, echo=FALSE, message = FALSE, warning = FALSE, cache = FALSE, out.width = '100%'}
plot_nowcast_from_case_reports(IN)
```

### KS
```{r KS, echo=FALSE, message = FALSE, warning = FALSE, cache = FALSE, out.width = '100%'}
plot_nowcast_from_case_reports(KS)
```

### KY
```{r KY, echo=FALSE, message = FALSE, warning = FALSE, cache = FALSE, out.width = '100%'}
plot_nowcast_from_case_reports(KY)
```

### LA
```{r LA, echo=FALSE, message = FALSE, warning = FALSE, cache = FALSE, out.width = '100%'}
plot_nowcast_from_case_reports(LA)
```

### MA
```{r MA, echo=FALSE, message = FALSE, warning = FALSE, cache = FALSE, out.width = '100%'}
plot_nowcast_from_case_reports(MA)
```

### MD
```{r MD, echo=FALSE, message = FALSE, warning = FALSE, cache = FALSE, out.width = '100%'}
plot_nowcast_from_case_reports(MD)
```

### ME
```{r ME, echo=FALSE, message = FALSE, warning = FALSE, cache = FALSE, out.width = '100%'}
plot_nowcast_from_case_reports(ME)
```

### MI
```{r MI, echo=FALSE, message = FALSE, warning = FALSE, cache = FALSE, out.width = '100%'}
plot_nowcast_from_case_reports(MI)
```

### MN
```{r MN, echo=FALSE, message = FALSE, warning = FALSE, cache = FALSE, out.width = '100%'}
plot_nowcast_from_case_reports(MN)
```

### MO
```{r MO, echo=FALSE, message = FALSE, warning = FALSE, cache = FALSE, out.width = '100%'}
plot_nowcast_from_case_reports(MO)
```

### MS
```{r MS, echo=FALSE, message = FALSE, warning = FALSE, cache = FALSE, out.width = '100%'}
plot_nowcast_from_case_reports(MS)
```

### MT
```{r MT, echo=FALSE, message = FALSE, warning = FALSE, cache = FALSE, out.width = '100%'}
plot_nowcast_from_case_reports(MT)
```

### NC
```{r NC, echo=FALSE, message = FALSE, warning = FALSE, cache = FALSE, out.width = '100%'}
plot_nowcast_from_case_reports(NC)
```

### ND
```{r ND, echo=FALSE, message = FALSE, warning = FALSE, cache = FALSE, out.width = '100%'}
plot_nowcast_from_case_reports(ND)
```

### NE
```{r NE, echo=FALSE, message = FALSE, warning = FALSE, cache = FALSE, out.width = '100%'}
plot_nowcast_from_case_reports(NE)
```

### NH
```{r NH, echo=FALSE, message = FALSE, warning = FALSE, cache = FALSE, out.width = '100%'}
plot_nowcast_from_case_reports(NH)
```

### NJ
```{r NJ, echo=FALSE, message = FALSE, warning = FALSE, cache = FALSE, out.width = '100%'}
plot_nowcast_from_case_reports(NJ)
```

### NM
```{r NM, echo=FALSE, message = FALSE, warning = FALSE, cache = FALSE, out.width = '100%'}
plot_nowcast_from_case_reports(NM)
```

### NV
```{r NV, echo=FALSE, message = FALSE, warning = FALSE, cache = FALSE, out.width = '100%'}
plot_nowcast_from_case_reports(NV)
```

### NY
```{r NY, echo=FALSE, message = FALSE, warning = FALSE, cache = FALSE, out.width = '100%'}
plot_nowcast_from_case_reports(NY)
```

### OH
```{r OH, echo=FALSE, message = FALSE, warning = FALSE, cache = FALSE, out.width = '100%'}
plot_nowcast_from_case_reports(OH)
```

### OK
```{r OK, echo=FALSE, message = FALSE, warning = FALSE, cache = FALSE, out.width = '100%'}
plot_nowcast_from_case_reports(OK)
```

### OR
```{r OR, echo=FALSE, message = FALSE, warning = FALSE, cache = FALSE, out.width = '100%'}
plot_nowcast_from_case_reports(OR)
```

### PA
```{r PA, echo=FALSE, message = FALSE, warning = FALSE, cache = FALSE, out.width = '100%'}
plot_nowcast_from_case_reports(PA)
```

### RI
```{r RI, echo=FALSE, message = FALSE, warning = FALSE, cache = FALSE, out.width = '100%'}
plot_nowcast_from_case_reports(RI)
```

### SC
```{r SC, echo=FALSE, message = FALSE, warning = FALSE, cache = FALSE, out.width = '100%'}
plot_nowcast_from_case_reports(SC)
```

### SD
```{r SD, echo=FALSE, message = FALSE, warning = FALSE, cache = FALSE, out.width = '100%'}
plot_nowcast_from_case_reports(SD)
```

### TN
```{r TN, echo=FALSE, message = FALSE, warning = FALSE, cache = FALSE, out.width = '100%'}
plot_nowcast_from_case_reports(TN)
```

### TX
```{r TX, echo=FALSE, message = FALSE, warning = FALSE, cache = FALSE, out.width = '100%'}
plot_nowcast_from_case_reports(TX)
```

### UT
```{r UT, echo=FALSE, message = FALSE, warning = FALSE, cache = FALSE, out.width = '100%'}
plot_nowcast_from_case_reports(UT)
```

### VA
```{r VA, echo=FALSE, message = FALSE, warning = FALSE, cache = FALSE, out.width = '100%'}
plot_nowcast_from_case_reports(VA)
```

### VT
```{r VT, echo=FALSE, message = FALSE, warning = FALSE, cache = FALSE, out.width = '100%'}
plot_nowcast_from_case_reports(VT)
```

### WA
```{r WA, echo=FALSE, message = FALSE, warning = FALSE, cache = FALSE, out.width = '100%'}
plot_nowcast_from_case_reports(WA)
```

### WI
```{r WI, echo=FALSE, message = FALSE, warning = FALSE, cache = FALSE, out.width = '100%'}
plot_nowcast_from_case_reports(WI)
```

### WY
```{r WY, echo=FALSE, message = FALSE, warning = FALSE, cache = FALSE, out.width = '100%'}
plot_nowcast_from_case_reports(WY)
```

## ![](nowcast-legend-cases.png)


