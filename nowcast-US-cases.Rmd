---
title: "Nowcasting from case reports"
date: "`r format(Sys.time(), '%B %d, %Y')`"
output:
  html_document:
    df_print: paged
---

<!-- Knit this page first -->

```{r setup, include=FALSE}

source('R/nowcast.R')
source('R/data.R')

```

<!-- Set params for US -->
```{r params, include=FALSE, message = FALSE, warning = FALSE, cache = FALSE}
params.US <- list(
  admin = "US", # state or country
  
  # https://www.imperial.ac.uk/media/imperial-college/medicine/sph/ide/gida-fellowships/Imperial-College-COVID19-NPI-modelling-16-03-2020.pdf
  IFR = .009, 
  
  # ascertainment (calculated and added later)
  # q = 1,

  # accepted value
  infectious.period = list(dist="exponential", mean=7),   
  
  # our analysis onset-to-reporting
  effective.infectious.period = list(dist="gamma", mean=5.95, shape=2.2788163), 
  
  # our analysis of US data
  incubation.period = list(dist="gamma", mean=5.89, shape=2.4265511), 
  
  # Our analysis of US data (not used)
  # report.to.death.period = list(dist="skewnormal", mean = 1.33, sd = sqrt(11.06),
  #                               location = -2.388990, # xi
  #                               scale = 4.322, # omega
  #                               shape = 1.447), # alpha
  # 
  # from China data: lognormal distribution with location 2.84, scale 0.52 
  # (Jung et al.) https://doi.org/10.3390/jcm9020523 
  # onset.to.death.period = list(dist="lognormal", mean = 19.9, sd = 11.4)
  
  # from China data: Kenji Mizumoto, Gerardo Chowell. "Estimating the risk of 2019 Novel Coronavirus death during the course of the outbreak in China, 2020" medRxiv preprint. https://doi.org/10.1101/2020.02.19.20025163
  onset.to.death.period = list(dist="gamma", mean = 16, shape = 4)
)

```

<!-- Get reports for US states -->
```{r data, include=FALSE, message = FALSE, warning = FALSE, cache = FALSE}

cases.US <- readRDS('data/cases.US.rds')
fatalities.US <- readRDS('data/fatalities.US.rds')

cases.US.all <- cases.US %>% dplyr::select(Date, cases = US)
fatalities.US.all <- fatalities.US %>% dplyr::select(Date, deaths = US)

```

<!-- Get q (ascertainment) -->
```{r ascertainment, include=FALSE, message = FALSE, warning = FALSE, cache = FALSE}


# calculate and load ascertainment (time varying q with upper and lower bounds)

params.US$q <- get_ascertainment(cases.US.all, fatalities.US.all, params.US, window = 7)
saveRDS(params.US,"data/params.US.rds")

# ## alternate contant q
# 
# params.US$q <- mean(params.US$q$mean.raw)
# 
# ## alternate q = grand mean
# 
# params.US$q <- list(mean = mean(params.US$q$mean.raw), 
#                     upper = mean(params.US$q$upper.raw), 
#                     lower = mean(params.US$q$lower.raw))

```

## {.tabset .tabset-fade}

### USA
<!-- calculate nowcasts for entire US  -->
```{r nowcast_US, include=FALSE, echo=FALSE, message = FALSE, warning = FALSE, cache = FALSE}

get_nowcast <- function(admin, cases, fatalities, params) {
  nowcast <- cases %>% select(Date, cases = admin) %>% 
    tbl_time(index = Date) %>% nowcast_from_case_reports(params)
  
  nowcast$deaths <- pull(fatalities, admin)
  nowcast$cum.deaths <- cumsum(nowcast$deaths)
  return(nowcast)
}

# start.time <- proc.time()
US <- get_nowcast("US", cases.US, fatalities.US, params.US)
# saveRDS(US.all,"data/US.nowcast.from.cases.rds")
# (proc.time()-start.time)['elapsed']/60

# get_US_nowcast <- function(state) {
#   nowcast <- cases.US %>% select(Date, cases = state) %>% 
#     tbl_time(index = Date) %>% nowcast_from_case_reports(params)
#   
#   nowcast$deaths <- pull(fatalities.US, state)
#   nowcast$cum.deaths <- cumsum(nowcast$deaths)
#   return(nowcast)
# }
# 
# US <- get_US_nowcast("US", cases.US, fatalities.US, params.US)
# # saveRDS(US.all,"data/US.nowcast.from.cases.rds")

# Export single plot
p <- plot_nowcast_from_case_reports(US, maxy = 10^8, legend = TRUE)
htmlwidgets::saveWidget(p, "USnowcast_plot.html")
```

```{r US, echo=FALSE, message = FALSE, warning = FALSE, cache = FALSE, out.width = '100%'}
plot_nowcast_from_case_reports(US, maxy = 10^8, legend = FALSE)
```

<!-- ```{r uncorrected} -->

<!-- params.US.uncorrected <- params.US -->
<!-- params.US.uncorrected$q <- 1 -->

<!-- US.all.uncorrected <- nowcast_from_case_reports(cases.US.all, params.US.uncorrected) -->

<!-- plot_nowcast_from_case_reports(US.all.uncorrected) %>% layout(showlegend = TRUE) -->

<!-- ``` -->


<!-- calculate nowcasts for US states -->
```{r nowcast_states, include=FALSE, echo=FALSE, message = FALSE, warning = FALSE, cache = FALSE}
# start.time <- proc.time()
AK <- get_nowcast("AK", cases.US, fatalities.US, params.US)
AL <- get_nowcast("AL", cases.US, fatalities.US, params.US)
AR <- get_nowcast("AR", cases.US, fatalities.US, params.US)
AZ <- get_nowcast("AZ", cases.US, fatalities.US, params.US)
CA <- get_nowcast("CA", cases.US, fatalities.US, params.US)
CO <- get_nowcast("CO", cases.US, fatalities.US, params.US)
CT <- get_nowcast("CT", cases.US, fatalities.US, params.US)
DC <- get_nowcast("DC", cases.US, fatalities.US, params.US)
DE <- get_nowcast("DE", cases.US, fatalities.US, params.US)
FL <- get_nowcast("FL", cases.US, fatalities.US, params.US)
GA <- get_nowcast("GA", cases.US, fatalities.US, params.US)
HI <- get_nowcast("HI", cases.US, fatalities.US, params.US)
IA <- get_nowcast("IA", cases.US, fatalities.US, params.US)
ID <- get_nowcast("ID", cases.US, fatalities.US, params.US)
IL <- get_nowcast("IL", cases.US, fatalities.US, params.US)
IN <- get_nowcast("IN", cases.US, fatalities.US, params.US)
KS <- get_nowcast("KS", cases.US, fatalities.US, params.US)
KY <- get_nowcast("KY", cases.US, fatalities.US, params.US)
LA <- get_nowcast("LA", cases.US, fatalities.US, params.US)
MA <- get_nowcast("MA", cases.US, fatalities.US, params.US)
MD <- get_nowcast("MD", cases.US, fatalities.US, params.US)
ME <- get_nowcast("ME", cases.US, fatalities.US, params.US)
MI <- get_nowcast("MI", cases.US, fatalities.US, params.US)
MN <- get_nowcast("MN", cases.US, fatalities.US, params.US)
MO <- get_nowcast("MO", cases.US, fatalities.US, params.US)
MS <- get_nowcast("MS", cases.US, fatalities.US, params.US)
MT <- get_nowcast("MT", cases.US, fatalities.US, params.US)
NC <- get_nowcast("NC", cases.US, fatalities.US, params.US)
ND <- get_nowcast("ND", cases.US, fatalities.US, params.US)
NE <- get_nowcast("NE", cases.US, fatalities.US, params.US)
NH <- get_nowcast("NH", cases.US, fatalities.US, params.US)
NJ <- get_nowcast("NJ", cases.US, fatalities.US, params.US)
NM <- get_nowcast("NM", cases.US, fatalities.US, params.US)
NV <- get_nowcast("NV", cases.US, fatalities.US, params.US)
NY <- get_nowcast("NY", cases.US, fatalities.US, params.US)
OH <- get_nowcast("OH", cases.US, fatalities.US, params.US)
OK <- get_nowcast("OK", cases.US, fatalities.US, params.US)
OR <- get_nowcast("OR", cases.US, fatalities.US, params.US)
PA <- get_nowcast("PA", cases.US, fatalities.US, params.US)
RI <- get_nowcast("RI", cases.US, fatalities.US, params.US)
SC <- get_nowcast("SC", cases.US, fatalities.US, params.US)
SD <- get_nowcast("SD", cases.US, fatalities.US, params.US)
TN <- get_nowcast("TN", cases.US, fatalities.US, params.US)
TX <- get_nowcast("TX", cases.US, fatalities.US, params.US)
UT <- get_nowcast("UT", cases.US, fatalities.US, params.US)
VA <- get_nowcast("VA", cases.US, fatalities.US, params.US)
VT <- get_nowcast("VT", cases.US, fatalities.US, params.US)
WA <- get_nowcast("WA", cases.US, fatalities.US, params.US)
WI <- get_nowcast("WI", cases.US, fatalities.US, params.US)
WY <- get_nowcast("WY", cases.US, fatalities.US, params.US)
GU <- get_nowcast("GU", cases.US, fatalities.US, params.US)
# MP <- get_nowcast("MP", cases.US, fatalities.US, params.US) # not enough data
PR <- get_nowcast("PR", cases.US, fatalities.US, params.US)
VI <- get_nowcast("VI", cases.US, fatalities.US, params.US)
# (proc.time()-start.time)['elapsed']/60
```

### AK
```{r AK, echo=FALSE, message = FALSE, warning = FALSE, cache = FALSE, out.width = '100%'}
plot_nowcast_from_case_reports(AK)
```

### AL
```{r AL, echo=FALSE, message = FALSE, warning = FALSE, cache = FALSE, out.width = '100%'}
plot_nowcast_from_case_reports(AL)
```

### AR
```{r AR, echo=FALSE, message = FALSE, warning = FALSE, cache = FALSE, out.width = '100%'}
plot_nowcast_from_case_reports(AR)
```

### AZ
```{r AZ, echo=FALSE, message = FALSE, warning = FALSE, cache = FALSE, out.width = '100%'}
plot_nowcast_from_case_reports(AZ)
```

### CA
```{r CA, echo=FALSE, message = FALSE, warning = FALSE, cache = FALSE, out.width = '100%'}
plot_nowcast_from_case_reports(CA)
```

### CO
```{r CO, echo=FALSE, message = FALSE, warning = FALSE, cache = FALSE, out.width = '100%'}
plot_nowcast_from_case_reports(CO)
```

### CT
```{r CT, echo=FALSE, message = FALSE, warning = FALSE, cache = FALSE, out.width = '100%'}
plot_nowcast_from_case_reports(CT)
```

### DC
```{r DC, echo=FALSE, message = FALSE, warning = FALSE, cache = FALSE, out.width = '100%'}
plot_nowcast_from_case_reports(DC)
```

### DE
```{r DE, echo=FALSE, message = FALSE, warning = FALSE, cache = FALSE, out.width = '100%'}
plot_nowcast_from_case_reports(DE)
```

### FL
```{r FL, echo=FALSE, message = FALSE, warning = FALSE, cache = FALSE, out.width = '100%'}
plot_nowcast_from_case_reports(FL)
```

### GA
```{r GA, echo=FALSE, message = FALSE, warning = FALSE, cache = FALSE, out.width = '100%'}
plot_nowcast_from_case_reports(GA)
```

### HI
```{r HI, echo=FALSE, message = FALSE, warning = FALSE, cache = FALSE, out.width = '100%'}
plot_nowcast_from_case_reports(HI)
```

### IA
```{r IA, echo=FALSE, message = FALSE, warning = FALSE, cache = FALSE, out.width = '100%'}
plot_nowcast_from_case_reports(IA)
```

### ID
```{r ID, echo=FALSE, message = FALSE, warning = FALSE, cache = FALSE, out.width = '100%'}
plot_nowcast_from_case_reports(ID)
```

### IL
```{r IL, echo=FALSE, message = FALSE, warning = FALSE, cache = FALSE, out.width = '100%'}
plot_nowcast_from_case_reports(IL)
```

### IN
```{r IN, echo=FALSE, message = FALSE, warning = FALSE, cache = FALSE, out.width = '100%'}
plot_nowcast_from_case_reports(IN)
```

### KS
```{r KS, echo=FALSE, message = FALSE, warning = FALSE, cache = FALSE, out.width = '100%'}
plot_nowcast_from_case_reports(KS)
```

### KY
```{r KY, echo=FALSE, message = FALSE, warning = FALSE, cache = FALSE, out.width = '100%'}
plot_nowcast_from_case_reports(KY)
```

### LA
```{r LA, echo=FALSE, message = FALSE, warning = FALSE, cache = FALSE, out.width = '100%'}
plot_nowcast_from_case_reports(LA)
```

### MA
```{r MA, echo=FALSE, message = FALSE, warning = FALSE, cache = FALSE, out.width = '100%'}
plot_nowcast_from_case_reports(MA)
```

### MD
```{r MD, echo=FALSE, message = FALSE, warning = FALSE, cache = FALSE, out.width = '100%'}
plot_nowcast_from_case_reports(MD)
```

### ME
```{r ME, echo=FALSE, message = FALSE, warning = FALSE, cache = FALSE, out.width = '100%'}
plot_nowcast_from_case_reports(ME)
```

### MI
```{r MI, echo=FALSE, message = FALSE, warning = FALSE, cache = FALSE, out.width = '100%'}
plot_nowcast_from_case_reports(MI)
```

### MN
```{r MN, echo=FALSE, message = FALSE, warning = FALSE, cache = FALSE, out.width = '100%'}
plot_nowcast_from_case_reports(MN)
```

### MO
```{r MO, echo=FALSE, message = FALSE, warning = FALSE, cache = FALSE, out.width = '100%'}
plot_nowcast_from_case_reports(MO)
```

### MS
```{r MS, echo=FALSE, message = FALSE, warning = FALSE, cache = FALSE, out.width = '100%'}
plot_nowcast_from_case_reports(MS)
```

### MT
```{r MT, echo=FALSE, message = FALSE, warning = FALSE, cache = FALSE, out.width = '100%'}
plot_nowcast_from_case_reports(MT)
```

### NC
```{r NC, echo=FALSE, message = FALSE, warning = FALSE, cache = FALSE, out.width = '100%'}
plot_nowcast_from_case_reports(NC)
```

### ND
```{r ND, echo=FALSE, message = FALSE, warning = FALSE, cache = FALSE, out.width = '100%'}
plot_nowcast_from_case_reports(ND)
```

### NE
```{r NE, echo=FALSE, message = FALSE, warning = FALSE, cache = FALSE, out.width = '100%'}
plot_nowcast_from_case_reports(NE)
```

### NH
```{r NH, echo=FALSE, message = FALSE, warning = FALSE, cache = FALSE, out.width = '100%'}
plot_nowcast_from_case_reports(NH)
```

### NJ
```{r NJ, echo=FALSE, message = FALSE, warning = FALSE, cache = FALSE, out.width = '100%'}
plot_nowcast_from_case_reports(NJ)
```

### NM
```{r NM, echo=FALSE, message = FALSE, warning = FALSE, cache = FALSE, out.width = '100%'}
plot_nowcast_from_case_reports(NM)
```

### NV
```{r NV, echo=FALSE, message = FALSE, warning = FALSE, cache = FALSE, out.width = '100%'}
plot_nowcast_from_case_reports(NV)
```

### NY
```{r NY, echo=FALSE, message = FALSE, warning = FALSE, cache = FALSE, out.width = '100%'}
plot_nowcast_from_case_reports(NY)
```

### OH
```{r OH, echo=FALSE, message = FALSE, warning = FALSE, cache = FALSE, out.width = '100%'}
plot_nowcast_from_case_reports(OH)
```

### OK
```{r OK, echo=FALSE, message = FALSE, warning = FALSE, cache = FALSE, out.width = '100%'}
plot_nowcast_from_case_reports(OK)
```

### OR
```{r OR, echo=FALSE, message = FALSE, warning = FALSE, cache = FALSE, out.width = '100%'}
plot_nowcast_from_case_reports(OR)
```

### PA
```{r PA, echo=FALSE, message = FALSE, warning = FALSE, cache = FALSE, out.width = '100%'}
plot_nowcast_from_case_reports(PA)
```

### RI
```{r RI, echo=FALSE, message = FALSE, warning = FALSE, cache = FALSE, out.width = '100%'}
plot_nowcast_from_case_reports(RI)
```

### SC
```{r SC, echo=FALSE, message = FALSE, warning = FALSE, cache = FALSE, out.width = '100%'}
plot_nowcast_from_case_reports(SC)
```

### SD
```{r SD, echo=FALSE, message = FALSE, warning = FALSE, cache = FALSE, out.width = '100%'}
plot_nowcast_from_case_reports(SD)
```

### TN
```{r TN, echo=FALSE, message = FALSE, warning = FALSE, cache = FALSE, out.width = '100%'}
plot_nowcast_from_case_reports(TN)
```

### TX
```{r TX, echo=FALSE, message = FALSE, warning = FALSE, cache = FALSE, out.width = '100%'}
plot_nowcast_from_case_reports(TX)
```

### UT
```{r UT, echo=FALSE, message = FALSE, warning = FALSE, cache = FALSE, out.width = '100%'}
plot_nowcast_from_case_reports(UT)
```

### VA
```{r VA, echo=FALSE, message = FALSE, warning = FALSE, cache = FALSE, out.width = '100%'}
plot_nowcast_from_case_reports(VA)
```

### VT
```{r VT, echo=FALSE, message = FALSE, warning = FALSE, cache = FALSE, out.width = '100%'}
plot_nowcast_from_case_reports(VT)
```

### WA
```{r WA, echo=FALSE, message = FALSE, warning = FALSE, cache = FALSE, out.width = '100%'}
plot_nowcast_from_case_reports(WA)
```

### WI
```{r WI, echo=FALSE, message = FALSE, warning = FALSE, cache = FALSE, out.width = '100%'}
plot_nowcast_from_case_reports(WI)
```

### WY
```{r WY, echo=FALSE, message = FALSE, warning = FALSE, cache = FALSE, out.width = '100%'}
plot_nowcast_from_case_reports(WY)
```

### Guam
```{r GU, echo=FALSE, message = FALSE, warning = FALSE, cache = FALSE, out.width = '100%'}
plot_nowcast_from_case_reports(GU)
```

<!-- ### Northern Mariana Islands -->
<!-- ```{r MP, echo=FALSE, message = FALSE, warning = FALSE, cache = FALSE, out.width = '100%'} -->
<!-- plot_nowcast_from_case_reports(MP) -->
<!-- ``` -->

### Puerto Rico
```{r PR, echo=FALSE, message = FALSE, warning = FALSE, cache = FALSE, out.width = '100%'}
plot_nowcast_from_case_reports(PR)
```

### US Virgin Islands
```{r VI, echo=FALSE, message = FALSE, warning = FALSE, cache = FALSE, out.width = '100%'}
plot_nowcast_from_case_reports(VI)
```

## ![](nowcast-legend-combined.png)

The nowcast for the whole US is calculated from case reports at the national level. It is not the sum of the state level nowcasts. The nowcast for the whole US does not necessarily agree with the the sum of state level nowcasts.

### Parameters

**Infection fatality rate** = `r params.US$IFR`

**Symptom-onset-to-reporting interval:**  
Distribution: `r params.US$effective.infectious.period$dist`  
Mean = `r params.US$effective.infectious.period$mean`  
Shape = `r params.US$effective.infectious.period$shape`

**Incubation period:**  
Distribution: `r params.US$incubation.period$dist`  
Mean = `r params.US$incubation.period$mean`  
Shape = `r params.US$incubation.period$shape`

**Symmptom-onset-to-death interval:**  
Distribution: `r params.US$onset.to.death.period$dist`  
Mean = `r params.US$onset.to.death.period$mean`  
Shape = `r params.US$onset.to.death.period$shape`  